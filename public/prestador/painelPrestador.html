<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel do Prestador - IDFlow</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../styles.css">
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>
</head>

<body>

<div class="sidebar">
  <h4>Menu</h4>
  <a href="#" onclick="mostrarSecao('eventos')">Eventos</a>
  <a href="#" onclick="mostrarSecao('entrada')">Entrada</a>
  <a href="#" onclick="mostrarSecao('saida')">Saída</a>
  <hr>
  <a href="#" onclick="logout()" class="text-danger">Sair</a>
</div>

<main class="main-content">
  <section id="eventos">
    <h2>Eventos Vinculados</h2>
    <div id="listaEventos"><p>Carregando eventos...</p></div>
  </section>

  <section id="entrada" class="hidden">
    <h2>Entrada de Participantes</h2>
    <div class="mb-3">
      <label class="form-label">Selecione o Evento</label>
      <select id="eventoEntradaSelect" class="form-select" onchange="carregarParticipantes('entrada')">
        <option value="">Selecione...</option>
      </select>
    </div>
    <div id="listaEntrada">Selecione um evento para visualizar.</div>
  </section>

  <section id="saida" class="hidden">
    <h2>Saída de Participantes</h2>
    <div class="mb-3">
      <label class="form-label">Selecione o Evento</label>
      <select id="eventoSaidaSelect" class="form-select" onchange="carregarParticipantes('saida')">
        <option value="">Selecione...</option>
      </select>
    </div>
    <div id="listaSaida">Selecione um evento para visualizar.</div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = "https://app-qreader.onrender.com/api";
let auth0 = null;
let eventos = [];
const prestadorId = sessionStorage.getItem('prestadorId');

// --------------------- Auth0 e Validação ----------------------
async function configureAuth0() {
  auth0 = await createAuth0Client({
    domain: "dev-agq6qfbtj4yee13n.us.auth0.com",
    client_id: "zH6qQUwI5LMYtM4zOfw7N1DokYo9ruMV",
    cacheLocation: "localstorage"
  });
}

window.onload = async () => {
  await configureAuth0();
  await carregarEventos();
  mostrarSecao('eventos');
};

function mostrarSecao(secao) {
  document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
  document.getElementById(secao).classList.remove('hidden');
}

// ----------------- Carregar eventos --------------------
async function carregarEventos() {
  try {
    const res = await fetch(`${API_BASE}/eventos/prestador?prestadorId=${prestadorId}`);
    eventos = await res.json();

    const selectEntrada = document.getElementById('eventoEntradaSelect');
    const selectSaida = document.getElementById('eventoSaidaSelect');

    const options = '<option value="">Selecione...</option>' +
      eventos.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');

    selectEntrada.innerHTML = options;
    selectSaida.innerHTML = options;

    let html = '';
    if (eventos.length === 0) {
      html = '<p>Nenhum evento vinculado.</p>';
    } else {
      html = `<table class="table table-dark table-bordered">
        <thead><tr><th>Nome</th><th>Período</th><th>Local</th></tr></thead><tbody>`;
      eventos.forEach(ev => {
        html += `<tr>
          <td>${ev.nome}</td>
          <td>${new Date(ev.dataInicio).toLocaleDateString()} - ${new Date(ev.dataFim).toLocaleDateString()}</td>
          <td>${ev.local || '-'}</td>
        </tr>`;
      });
      html += '</tbody></table>';
    }

    document.getElementById('listaEventos').innerHTML = html;
  } catch (error) {
    console.error("Erro ao carregar eventos:", error);
    document.getElementById('listaEventos').innerHTML = '<p>Erro ao carregar eventos.</p>';
  }
}

// ----------------- Carregar Participantes --------------------
async function carregarParticipantes(tipo) {
  const eventoId = tipo === 'entrada'
    ? document.getElementById('eventoEntradaSelect').value
    : document.getElementById('eventoSaidaSelect').value;

  const listaDiv = tipo === 'entrada' ? 'listaEntrada' : 'listaSaida';

  if (!eventoId) {
    document.getElementById(listaDiv).innerHTML = '<p>Selecione um evento para visualizar.</p>';
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/participantes/by-evento/${eventoId}`);
    const participantes = await res.json();

    if (!participantes.length) {
      document.getElementById(listaDiv).innerHTML = '<p>Nenhum participante cadastrado.</p>';
      return;
    }

    let html = `<table class="table table-dark table-bordered">
      <thead><tr><th>Nome</th><th>CPF</th><th>Empresa</th><th>Ações</th></tr></thead><tbody>`;

    participantes.forEach(p => {
      html += `<tr>
        <td>${p.nome}</td>
        <td>${p.cpf}</td>
        <td>${p.empresa}</td>
        <td>
          <button class="btn btn-sm btn-${tipo === 'entrada' ? 'success' : 'warning'}"
            onclick="registrar${tipo === 'entrada' ? 'Checkin' : 'Checkout'}('${p.id}', '${eventoId}')">
            ${tipo === 'entrada' ? 'Check-in' : 'Check-out'}
          </button>
        </td>
      </tr>`;
    });

    html += '</tbody></table>';
    document.getElementById(listaDiv).innerHTML = html;
  } catch (err) {
    console.error("Erro ao carregar participantes:", err);
    document.getElementById(listaDiv).innerHTML = '<p>Erro ao carregar participantes.</p>';
  }
}

// ----------------- Checkin / Checkout --------------------
async function registrarCheckin(participanteId, eventoId) {
  const res = await fetch(`${API_BASE}/checkin/entrada`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ participanteId, eventoId })
  });

  alert(res.ok ? 'Check-in realizado com sucesso!' : 'Erro ao realizar check-in.');
}

async function registrarCheckout(participanteId, eventoId) {
  const res = await fetch(`${API_BASE}/checkin/saida`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ participanteId, eventoId })
  });

  alert(res.ok ? 'Check-out realizado com sucesso!' : 'Erro ao realizar check-out.');
}

// ----------------- Logout --------------------
async function logout() {
  sessionStorage.clear();
  if (auth0) {
    await auth0.logout({
      logoutParams: { returnTo: window.location.origin + "/login/login.html" }
    });
  } else {
    window.location.href = "/login/login.html";
  }
}
</script>

</body>
</html>