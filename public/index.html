<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitura de QR Code</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Leitura de QR Code</h1>
    <button id="open-camera-btn">Abrir Câmera</button>
    <div id="video-container">
        <video id="camera-feed" autoplay playsinline></video>
        <p class="loading-message">Carregando...</p>
        <p class="error-message" style="display: none;">Erro ao acessar a câmera.<br>Clique aqui para tentar novamente.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const openCameraBtn = document.getElementById('open-camera-btn');
            const videoContainer = document.getElementById('video-container');
            const cameraFeed = document.getElementById('camera-feed');
            const loadingMessage = document.querySelector('.loading-message');
            const errorMessage = document.querySelector('.error-message');

            let intervalId;

            openCameraBtn.addEventListener('click', function() {
                openCamera();
            });

            errorMessage.addEventListener('click', function() {
                sessionStorage.removeItem('id');
                errorMessage.style.display = 'none';
                openCamera();
            });

            function openCamera() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                        .then(function(stream) {
                            videoContainer.style.display = 'block';
                            loadingMessage.style.display = 'block';
                            errorMessage.style.display = 'none';

                            cameraFeed.srcObject = stream;
                            cameraFeed.play();

                            intervalId = setInterval(function() {
                                captureQRCode();
                            }, 1000);
                        })
                        .catch(function(error) {
                            console.error('Erro ao acessar a câmera:', error);
                            errorMessage.style.display = 'block';
                            clearInterval(intervalId); // Pare de ler o QRCode quando houver erro
                        })
                        .finally(() => {
                            loadingMessage.style.display = 'none';
                        });
                } else {
                    alert('Seu dispositivo não suporta acesso à câmera.');
                }
            }

            function captureQRCode() {
                const canvasElement = document.createElement('canvas');
                const canvas = canvasElement.getContext('2d');

                canvasElement.width = cameraFeed.videoWidth;
                canvasElement.height = cameraFeed.videoHeight;
                canvas.drawImage(cameraFeed, 0, 0, cameraFeed.videoWidth, cameraFeed.videoHeight);
                const imageData = canvas.getImageData(0, 0, cameraFeed.videoWidth, cameraFeed.videoHeight);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    const id = code.data;
                    if (!sessionStorage.getItem('id')) {
                        sessionStorage.setItem('id', id);
                    }

                    // Verifique se o QRCode já foi utilizado anteriormente
                    fetch(`https://qrepo.onrender.com/verificar?id=${id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert('QRCode já utilizado. Por favor, tente novamente.');
                                clearInterval(intervalId);
                            } else {
                                window.location.href = 'aplicacao.html';
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao verificar QRCode:', error);
                            alert('Erro ao verificar QRCode. Por favor, tente novamente.');
                            clearInterval(intervalId);
                        });
                }
            }
        });
    </script>
</body>
</html>
