<!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Funcionários</title>

  <meta name="color-scheme" content="dark">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <link rel="stylesheet" href="../styles.css" />
</head>

<body style="display: none;">
  <nav class="container-fluid">
    <ul>
      <li><strong>Sistema QReader</strong></li>
    </ul>
    <ul>
      <li><strong>Bem-vindo, <span id="nome-usuario"></span></strong></li>
      <li><a href="#" role="button" id="return-home-btn">Voltar</a></li>
      <li><a href="#" role="button" id="logout-btn">Sair</a></li>
    </ul>
  </nav>

  <main class="container">
    <div class="grid">
      <section>
        <hgroup>
          <h2>Cadastro de Funcionários</h2>
          <h3>Preencha os dados abaixo</h3>
        </hgroup>

        <form id="cadastroForm" aria-label="Formulário de Cadastro">
          <input type="text" id="nome" name="nome" placeholder="Nome" aria-label="Nome" required />
          <input type="text" id="cpf" name="cpf" placeholder="CPF" aria-label="CPF" required />
          <select id="empresa" name="empresa" aria-label="Empresa" required>
            <option value="" disabled selected>Selecione a empresa</option>
            <option value="empresa1">Empresa 1</option>
            <option value="empresa2">Empresa 2</option>
            <option value="empresa3">Empresa 3</option>
          </select>
          <input type="hidden" id="id" name="id" />
          <input type="hidden" id="solicitante" name="solicitante" />

          <button type="submit" aria-label="Salvar Funcionário">
            <span>Salvar</span>
            <span class="loading" style="display: none;">Carregando...</span>
          </button>
        </form>
      </section>
    </div>
  </main>

  <footer class="container">
    <small><a href="#">Política de Privacidade</a> • <a href="#">Termos de Uso</a></small>
  </footer>

  <script>
    const token = sessionStorage.getItem('token');
    const solicitante = sessionStorage.getItem('solicitante');
    const id = sessionStorage.getItem('id');

    if (!token || !solicitante || !id) {
      window.location.href = '../login/login.html';
    } else {
      document.getElementById('nome-usuario').textContent = solicitante;
      document.body.style.display = 'block';
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = '../login/login.html';
    }

    document.getElementById('return-home-btn').addEventListener('click', function () {
      window.location.href = '../index.html';
    });

    const url = 'https://app-qreader.onrender.com';

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('id').value = id;
      document.getElementById('solicitante').value = solicitante;

      document.getElementById('cadastroForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.querySelector('.loading').style.display = 'inline';

        const formData = new FormData(this);
        const jsonData = {};
        formData.forEach((value, key) => {
          jsonData[key] = value;
        });

        fetch(url + '/cadastrar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(jsonData)
        })
          .then(response => {
            if (response.ok) {
              alert('Funcionário cadastrado com sucesso!');
              window.location.href = '../index.html';
            } else {
              throw new Error('Erro ao cadastrar funcionário.');
            }
          })
          .catch(error => {
            console.error('Erro ao cadastrar funcionário:', error);
            alert('Erro ao cadastrar funcionário. Por favor, tente novamente.');
          })
          .finally(() => {
            submitButton.disabled = false;
            submitButton.querySelector('.loading').style.display = 'none';
          });
      });
    });
  </script>
</body>
</html>
