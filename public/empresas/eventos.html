<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gerenciamento de Eventos - QReader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
<div class="container mt-4">
  <h2 class="mb-4">Gerenciamento de Eventos</h2>

  <!-- Botão para abrir modal de criação -->
  <button class="btn btn-success mb-3" onclick="abrirModalCriarEvento()">+ Novo Evento</button>

  <!-- Lista de eventos -->
  <div id="listaEventos">Carregando eventos...</div>
</div>

<!-- Modal de criação/edição -->
<div class="modal fade" id="modalEvento" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form onsubmit="salvarEvento(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="tituloModalEvento">Novo Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="eventoId">

          <div class="mb-3">
            <label for="nome" class="form-label">Nome do Evento</label>
            <input type="text" id="nome" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="descricao" class="form-label">Descrição</label>
            <textarea id="descricao" class="form-control"></textarea>
          </div>

          <div class="mb-3">
            <label for="local" class="form-label">Local</label>
            <input type="text" id="local" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Data de Início</label>
            <input type="date" id="dataInicio" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Data de Fim</label>
            <input type="date" id="dataFim" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Vincular Prestadores</label>
            <select multiple id="prestadores" class="form-select"></select>
            <div class="form-text">Segure CTRL (ou CMD) para selecionar múltiplos prestadores</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = "https://app-qreader.onrender.com/api";
  let eventos = [];
  const empresaId = sessionStorage.getItem('empresaId');

  async function carregarEventos() {
    const res = await fetch(`${API_BASE}/eventos/empresa?empresaId=${empresaId}`);
    eventos = await res.json();
    renderizarListaEventos();
  }

  function renderizarListaEventos() {
    if (!eventos.length) {
      document.getElementById('listaEventos').innerHTML = `<p>Sem eventos cadastrados.</p>`;
      return;
    }

    let html = `<table class="table table-dark table-bordered">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Local</th>
          <th>Período</th>
          <th>Prestadores</th>
          <th>Ações</th>
        </tr>
      </thead><tbody>`;

    eventos.forEach(ev => {
      const periodo = `${new Date(ev.dataInicio).toLocaleDateString()} - ${new Date(ev.dataFim).toLocaleDateString()}`;
      const prestadores = ev.prestadores?.map(p => p.prestador.nome).join(', ') || 'Nenhum';

      html += `<tr>
        <td>${ev.nome}</td>
        <td>${ev.local}</td>
        <td>${periodo}</td>
        <td>${prestadores}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editarEvento('${ev.id}')">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="deletarEvento('${ev.id}')">Excluir</button>
        </td>
      </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById('listaEventos').innerHTML = html;
  }

  async function abrirModalCriarEvento() {
    document.getElementById('tituloModalEvento').innerText = "Criar Novo Evento";
    limparFormulario();
    await carregarPrestadores();
    const modal = new bootstrap.Modal(document.getElementById('modalEvento'));
    modal.show();
  }

  async function carregarPrestadores() {
    const res = await fetch(`${API_BASE}/users/prestadores?empresaId=${empresaId}`);
    const prestadores = await res.json();
    const select = document.getElementById('prestadores');
    select.innerHTML = prestadores.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
  }

  function editarEvento(id) {
    const evento = eventos.find(e => e.id === id);
    if (!evento) return;
    document.getElementById('tituloModalEvento').innerText = "Editar Evento";
    document.getElementById('eventoId').value = evento.id;
    document.getElementById('nome').value = evento.nome;
    document.getElementById('descricao').value = evento.descricao;
    document.getElementById('local').value = evento.local;
    document.getElementById('dataInicio').value = evento.dataInicio.split('T')[0];
    document.getElementById('dataFim').value = evento.dataFim.split('T')[0];

    carregarPrestadores().then(() => {
      const select = document.getElementById('prestadores');
      const prestadoresIds = evento.prestadores.map(p => p.prestadorId);
      [...select.options].forEach(opt => {
        if (prestadoresIds.includes(opt.value)) {
          opt.selected = true;
        }
      });
    });

    const modal = new bootstrap.Modal(document.getElementById('modalEvento'));
    modal.show();
  }

  async function salvarEvento(event) {
    event.preventDefault();
    const id = document.getElementById('eventoId').value;
    const body = {
      nome: document.getElementById('nome').value,
      descricao: document.getElementById('descricao').value,
      local: document.getElementById('local').value,
      dataInicio: document.getElementById('dataInicio').value,
      dataFim: document.getElementById('dataFim').value,
      empresaId: empresaId,
      prestadoresIds: Array.from(document.getElementById('prestadores').selectedOptions).map(o => o.value)
    };

    const url = id ? `${API_BASE}/eventos/${id}` : `${API_BASE}/eventos`;
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      alert('Evento salvo com sucesso!');
      carregarEventos();
      bootstrap.Modal.getInstance(document.getElementById('modalEvento')).hide();
    } else {
      alert('Erro ao salvar evento.');
    }
  }

  async function deletarEvento(id) {
    const confirmar = confirm('Deseja realmente excluir este evento?');
    if (!confirmar) return;

    const res = await fetch(`${API_BASE}/eventos/${id}`, { method: 'DELETE' });
    if (res.ok) {
      alert('Evento excluído com sucesso!');
      carregarEventos();
    } else {
      alert('Erro ao excluir evento.');
    }
  }

  function limparFormulario() {
    document.getElementById('eventoId').value = '';
    document.getElementById('nome').value = '';
    document.getElementById('descricao').value = '';
    document.getElementById('local').value = '';
    document.getElementById('dataInicio').value = '';
    document.getElementById('dataFim').value = '';
    document.getElementById('prestadores').innerHTML = '';
  }

  window.onload = carregarEventos;
</script>
</body>
</html>